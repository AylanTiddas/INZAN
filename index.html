<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Découvrez et explorez des milliers de proverbes kabyles (Inzan). Une collection interactive de la sagesse populaire de Kabylie avec des explications, des favoris et des suggestions par IA.">
    
    <title>Inzan n Teqbaylit - Trésors de la Sagesse Kabyle</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tinos:ital,wght@0,400;0,700;1,400&family=Raleway:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext y=%22.9em%22 font-size=%2290%22 fill=%22%234A7C59%22%3E%E2%9C%A7%3C/text%3E%3C/svg%3E">
    
    <style>
        /* Amélioration de la palette de couleurs et du design général */
        :root {
            --color-bg: #F9F7F3; /* Fond légèrement plus chaud */
            --color-bg-card: #FFFFFF;
            --color-bg-alt: #F0EFEA;
            --color-text: #3D4A3A;
            --color-text-light: #6B7280;
            --color-heading: #2F4F4F;
            --color-primary: #4A7C59; /* Vert forêt profond */
            --color-secondary: #3A644B;
            --color-accent: #C79A2A; /* Or vieilli */
            --color-border: #E5E7EB;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.04);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.08), 0 2px 4px -2px rgb(0 0 0 / 0.08);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --font-serif: 'Tinos', serif;
            --font-sans: 'Raleway', sans-serif;
        }

        html.dark {
            --color-bg: #101418;
            --color-bg-card: #1A2026;
            --color-bg-alt: #1F272E;
            --color-text: #D1D5DB;
            --color-text-light: #9CA3AF;
            --color-heading: #F9FAFB;
            --color-primary: #52B788;
            --color-secondary: #3E9469;
            --color-accent: #FBBF24;
            --color-border: #374151;
        }

        body {
            background-color: var(--color-bg);
            font-family: var(--font-sans);
            color: var(--color-text);
            /* Motif de fond plus subtil et élégant */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.03'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Amélioration de la lisibilité et des transitions */
        .action-btn, .theme-pill-button, .card-theme-badge, .nav-btn, #back-to-top { 
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .theme-pill-button.active { 
            box-shadow: var(--shadow-md); 
            transform: translateY(-2px); 
            background-color: var(--color-primary);
            color: white !important;
        }
        .card-theme-badge:hover { 
            background-color: var(--color-accent); 
            color: var(--color-secondary); 
            transform: scale(1.05); 
        }
        .search-highlight { 
            background-color: var(--color-accent); 
            padding: 1px 4px; 
            border-radius: 4px; 
            color: var(--color-bg-card); 
            font-weight: 700; 
        }

        /* Animation d'apparition plus douce */
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .fade-in { 
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        .stagger-in {
             animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) both;
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease-in-out; }

        /* Effet de surbrillance amélioré */
        .highlight { 
            transition: all 0.4s ease; 
            transform: scale(1.02); 
            box-shadow: 0 0 0 4px color-mix(in srgb, var(--color-accent) 50%, transparent), var(--shadow-lg); 
            border-radius: 0.75rem; /* Correspond au radius de la carte */
        }
        
        /* Toast notification avec une meilleure animation */
        #toast { transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        #back-to-top.visible { opacity: 1; visibility: visible; transform: translateY(0); }

        /* Styles pour le loader */
        .loader { 
            width: 20px; height: 20px; 
            border: 3px solid #FFF; 
            border-bottom-color: transparent; 
            border-radius: 50%; 
            display: inline-block; 
            box-sizing: border-box; 
            animation: rotation 1s linear infinite; 
        }
        .loader-dark { border-color: #666; border-bottom-color: transparent; }
        html.dark .loader-dark { border-color: #9CA3AF; border-bottom-color: transparent; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Barre de défilement personnalisée */
        .custom-scrollbar::-webkit-scrollbar { height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 10px; border: 2px solid transparent; background-clip: content-box;}
        html.dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #4B5563; }
        
        /* Styles actifs pour la navigation, plus visibles */
        .nav-btn.active.mobile { 
            color: var(--color-primary); 
            transform: translateY(-4px) scale(1.1); 
            background-color: var(--color-bg); 
            border-radius: 50%; 
        }
        .nav-btn.active.desktop { 
            color: var(--color-primary); 
            border-color: var(--color-primary); 
            background-color: color-mix(in srgb, var(--color-primary) 10%, transparent);
        }
        
        /* Styles pour la modale */
        #modal-backdrop.visible { opacity: 1; pointer-events: auto; }
        #modal-content.visible { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; }
        #modal-body { -webkit-overflow-scrolling: touch; }

        /* Amélioration de la typographie du contenu généré (prose) */
        .prose h3 { margin-top: 1.5em; margin-bottom: 0.6em; font-size: 1.2em; font-weight: bold; color: var(--color-primary); border-bottom: 1px solid var(--color-border); padding-bottom: 0.3em;}
        .prose p, .prose ul { margin-bottom: 1em; line-height: 1.6; }
        .prose ul { list-style-position: inside; padding-left: 1em; }
        .prose li { margin-bottom: 0.5em; }

        /* Style pour le bouton favori */
        .favorite-btn.favorited svg { fill: #EC4899; stroke: #EC4899; color: #EC4899; transform: scale(1.1); }

        /* Styles améliorés pour le Quiz */
        .quiz-option { border: 2px solid var(--color-border); padding: 0.75rem 1rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s ease; }
        .quiz-option:hover { border-color: var(--color-primary); background-color: color-mix(in srgb, var(--color-primary) 10%, transparent); }
        .quiz-option.correct { border-color: #10B981; background-color: #D1FAE5; color: #064E3B; font-weight: bold; transform: scale(1.02); }
        html.dark .quiz-option.correct { background-color: #064E3B; color: #D1FAE5; }
        .quiz-option.incorrect { border-color: #EF4444; background-color: #FEE2E2; color: #991B1B; font-weight: bold; }
        html.dark .quiz-option.incorrect { background-color: #991B1B; color: #FEE2E2; }
        .quiz-option[disabled] { cursor: not-allowed; opacity: 0.7; }
        
        /* Style pour le bouton de suppression de la recherche */
        .search-wrapper { position: relative; }
        .clear-search-btn {
            position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%);
            color: var(--color-text-light); opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .search-wrapper input:not(:placeholder-shown) + .clear-search-btn {
            opacity: 1; pointer-events: auto; cursor: pointer;
        }

        /* Amélioration de l'accessibilité au focus */
        :focus-visible {
            outline: 3px solid var(--color-accent);
            outline-offset: 2px;
            border-radius: 0.375rem;
        }
        #modal-content :focus-visible {
            border-radius: 0.125rem;
        }

        /* Styles pour l'écran de lancement */
        #splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #splash-logo {
            animation: zoomIn 1s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        /* Styles pour le bouton "Charger Plus" */
        #load-more-btn.hidden { display: none; }
        #load-more-btn.loading { opacity: 0.7; cursor: wait; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8 pb-32 sm:pb-8">
    
    <div id="splash-screen" class="fixed inset-0 bg-[var(--color-bg)] z-[200] flex flex-col items-center justify-center transition-opacity duration-700 ease-out">
        <div id="splash-logo" class="opacity-0">
            <svg width="100" height="100" viewBox="0 0 100 100" class="text-[var(--color-accent)]">
                <text x="50" y="85" font-size="90" text-anchor="middle" fill="currentColor">ⵣ</text>
            </svg>
        </div>
        <p class="text-2xl font-serif font-bold text-[var(--color-heading)] mt-4">Inzan n Teqbaylit</p>
    </div>

    <div class="max-w-7xl mx-auto">
        
        <header class="relative text-center mb-8 md:mb-12">
            <div class="absolute top-0 right-0 z-50">
                <button id="theme-toggle" aria-label="Changer de thème" class="p-2 rounded-full bg-[var(--color-bg-card)] text-[var(--color-text)] shadow-md hover:scale-110 transition-transform">
                    <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
            </div>

            <h1 class="text-4xl md:text-6xl font-serif font-bold text-[var(--color-heading)] mb-2 flex flex-col sm:flex-row justify-center items-center gap-2 sm:gap-4 pt-4">
                <svg width="40" height="40" viewBox="0 0 100 100" class="text-[var(--color-accent)] hidden md:inline-block"><text x="50" y="85" font-size="90" text-anchor="middle" fill="currentColor">ⵟ</text></svg>
                <span>Inzan n Teqbaylit</span>
                <svg width="40" height="40" viewBox="0 0 100 100" class="text-[var(--color-accent)] hidden md:inline-block"><text x="50" y="85" font-size="90" text-anchor="middle" fill="currentColor">ⵣ</text></svg>
            </h1>
            <p class="text-lg md:text-xl text-[var(--color-text-light)] font-light">Trésors de la Sagesse Kabyle</p>
        </header>

        <nav id="desktop-nav" class="hidden sm:flex justify-center mb-8">
            <div class="flex items-center gap-2 p-2 bg-[var(--color-bg-card)]/80 backdrop-blur-md rounded-xl shadow-md border border-[var(--color-border)]">
                <button data-tab="accueil-tab" class="nav-btn desktop flex items-center gap-2 px-4 py-2 text-[var(--color-text)] rounded-lg border-2 border-transparent">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    <span class="font-semibold">Accueil</span>
                </button>
                <button data-tab="explorer-tab" class="nav-btn desktop flex items-center gap-2 px-4 py-2 text-[var(--color-text)] rounded-lg border-2 border-transparent">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    <span class="font-semibold">Explorer</span>
                </button>
                <button data-tab="favoris-tab" class="nav-btn desktop flex items-center gap-2 px-4 py-2 text-[var(--color-text)] rounded-lg border-2 border-transparent">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                    <span class="font-semibold">Favoris</span>
                </button>
                <button data-tab="ai-sage-tab" class="nav-btn desktop flex items-center gap-2 px-4 py-2 text-[var(--color-text)] rounded-lg border-2 border-transparent">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                    <span class="font-semibold">Sage AI</span>
                </button>
                <button data-tab="quiz-tab" class="nav-btn desktop flex items-center gap-2 px-4 py-2 text-[var(--color-text)] rounded-lg border-2 border-transparent">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
                    <span class="font-semibold">Quiz</span>
                </button>
            </div>
        </nav>

        <main>
            <section id="accueil-tab" class="tab-content" aria-labelledby="proverb-of-the-day-title">
                <div class="max-w-4xl mx-auto mb-10 text-center p-6 bg-[var(--color-bg-card)]/70 rounded-xl shadow-inner border border-[var(--color-border)]">
                    <p class="text-lg text-[var(--color-secondary)] italic font-light">
                        Une Banque de <strong class="text-[var(--color-primary)] font-semibold">"plus de 2000 proverbes"</strong>
                        <p class="text-[var(--color-text-light)] font-medium">Découvrez et explorez des milliers de proverbes kabyles (Inzan). Une collection interactive de la sagesse populaire de Kabylie avec des explications, des favoris et une recherche assitée par IA.</p>
                        <span class="block mt-2 font-medium text-[var(--color-primary)]">"Anzi am ddwa, ilaq ad t-yesseqdec umdan akken iwulem."</span>
                    </p>
                </div>
                <h2 id="proverb-of-the-day-title" class="text-3xl font-serif text-[var(--color-primary)] mb-5 text-center font-semibold">Proverbe du Jour 💡</h2>
                <div id="proverb-of-the-day-card" class="max-w-3xl mx-auto fade-in">
                    <div class="bg-[var(--color-bg-card)] p-6 rounded-xl shadow-2xl border-t-8 border-[var(--color-accent)] flex flex-col justify-center items-center h-40">
                         <span class="loader loader-dark"></span> 
                         <p class="mt-4 text-sm text-[var(--color-text-light)]">Chargement de la sagesse...</p>
                    </div>
                </div>

                <div class="max-w-3xl mx-auto mt-12 fade-in">
                    <div class="bg-gradient-to-br from-yellow-50/50 to-amber-100/50 dark:from-gray-700/50 dark:to-gray-800/50 border-t-4 border-[var(--color-accent)] rounded-xl p-6 flex flex-col sm:flex-row items-center gap-6 shadow-lg">
                        <div class="flex-shrink-0 text-[var(--color-accent)]">
                            <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-serif font-bold text-[var(--color-heading)] mb-2">Découvrez l'Œuvre Originale</h3>
                            <p class="text-[var(--color-text)] mb-2">
                                Une partie de cette banque de proverbes est extraite des 4 tomes de l'œuvre magistrale de Monsieur Aomar SIDER : <strong class="text-[var(--color-primary)] font-semibold">"INZAN amek i d-llan"</strong> ("Origines des proverbes et expressions kabyles").
                            </p>
                            <p class="text-sm text-[var(--color-text-light)]">
                        </strong>Son livre, avec les explications étymologiques et l'origine détaillée de chaque proverbe, est disponible à la vente en 4 tomes dans les librairies.</strong>
                            </p>
                        </div>
                    </div>
                </div>

                <footer class="text-center mt-16 py-6 border-t-2 border-[var(--color-border)]">
                    <p class="text-[var(--color-text-light)] font-medium">Une collection de la sagesse populaire kabyle.</p>
                    <p class="text-sm text-[var(--color-text-light)] mt-1">Application développée par TAMAZIRT Boussad. <button id="about-btn" class="text-[var(--color-primary)] underline">En savoir plus</button>.</p>
                </footer>
            </section>

            <section id="explorer-tab" class="tab-content" aria-labelledby="explorer-title">
                 <div class="sticky top-4 z-20 bg-[var(--color-bg-card)]/80 backdrop-blur-md rounded-xl shadow-lg border border-[var(--color-border)] mb-6">
                     <div class="p-4 space-y-4">
                        <div class="flex flex-col sm:flex-row gap-4 items-stretch">
                            <div class="search-wrapper flex-grow">
                                <input type="text" id="search-input" placeholder="Rechercher par mot-clé ou thème..." aria-label="Champ de recherche de proverbe" class="w-full p-3 pr-10 border-2 border-[var(--color-border)] rounded-lg focus:border-[var(--color-primary)] focus:ring-2 focus:ring-[var(--color-primary)]/30 transition duration-200 text-lg shadow-inner bg-[var(--color-bg-card)]">
                                <button class="clear-search-btn" aria-label="Vider la recherche">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                            <button id="random-btn" aria-label="Afficher un proverbe aléatoire" class="w-full sm:w-auto px-5 py-3 bg-[var(--color-accent)] text-white font-semibold rounded-lg hover:bg-[var(--color-primary)] transition-all duration-300 flex items-center justify-center gap-2 shadow-md transform hover:scale-[1.02]">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M21 21v-5h-5"/></svg>
                                <span>Aléatoire</span>
                            </button>
                        </div>
                        <nav id="theme-filter-nav" aria-label="Filtres de thèmes Kabyles">
                            <div class="flex items-center gap-3">
                                <h3 class="text-sm font-bold text-[var(--color-heading)] flex-shrink-0">Thèmes:</h3>
                                <div class="flex-grow overflow-x-auto custom-scrollbar">
                                    <div id="theme-list-container" class="flex gap-2 py-1">
                                        </div>
                                </div>
                            </div>
                        </nav>
                    </div>
                </div>
                
                <div id="results-feedback" class="mb-4 text-center text-[var(--color-text-light)] font-semibold min-h-[24px]"></div>

                <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 min-h-[400px]">
                    <div id="initial-load-message" class="md:col-span-2 xl:col-span-3 text-center p-8 bg-[var(--color-bg-card)] rounded-lg shadow-inner flex flex-col items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-[var(--color-text-light)] opacity-70"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
                        <p class="mt-4 text-lg text-[var(--color-text-light)]">Commencez votre recherche pour trouver un proverbe.</p>
                        <p class="text-md text-[var(--color-text-light)]">Ou cliquez sur "Aléatoire" pour une découverte.</p>
                    </div>
                </div>
                
                <div class="text-center mt-8">
                    <button id="load-more-btn" class="hidden w-full max-w-sm px-8 py-3 bg-[var(--color-primary)] text-white font-semibold rounded-lg shadow-md hover:bg-[var(--color-secondary)] transition-colors duration-300">
                        Charger 50 proverbes supplémentaires
                    </button>
                </div>

                <p id="no-results" class="text-center text-2xl text-[var(--color-text-light)] mt-12 hidden font-serif p-4 border border-dashed rounded-lg">
                    😔 Aucun proverbe ne correspond à votre recherche. <br> <span class="text-lg font-sans">Essayez de modifier vos mots-clés.</span>
                </p>
            </section>
            
            <section id="favoris-tab" class="tab-content" aria-labelledby="favoris-title">
                <h2 id="favoris-title" class="text-3xl font-serif text-[var(--color-primary)] mb-5 text-center font-semibold">Mes Favoris ❤️</h2>
                <div id="favorites-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 min-h-[400px]"></div>
                <div id="no-favorites" class="text-center text-xl text-[var(--color-text-light)] mt-12 hidden font-serif p-4">
                    <p>Vous n'avez pas encore de proverbes favoris.</p>
                    <button id="go-to-explorer-btn" class="mt-4 px-5 py-2 bg-[var(--color-primary)] text-white font-semibold rounded-lg shadow-md hover:scale-[1.02] transition-transform">Explorer les proverbes</button>
                </div>
            </section>
            
            <section id="ai-sage-tab" class="tab-content" aria-labelledby="ai-sage-title">
                 <h2 id="ai-sage-title" class="text-3xl font-serif text-[var(--color-primary)] mb-5 text-center font-semibold">Le Sage Artificiel 🤖</h2>
                <div class="fade-in max-w-3xl mx-auto bg-[var(--color-bg-card)]/95 p-6 rounded-xl shadow-lg border border-[var(--color-border)]">
                    <p class="text-center text-[var(--color-text-light)] mb-4">Décrivez une situation, et laissez notre sage vous proposer les proverbes les plus pertinents.</p>
                    <textarea id="ai-context-input" class="w-full p-3 border-2 border-[var(--color-border)] rounded-lg focus:border-[var(--color-primary)] focus:ring-2 focus:ring-[var(--color-primary)]/30 transition duration-200 text-lg shadow-inner mb-4 bg-[var(--color-bg)]" rows="3" placeholder="Exemple : Mon ami parle beaucoup mais n'agit jamais..."></textarea>
                    <button id="ai-suggest-btn" class="w-full px-5 py-3 bg-[var(--color-secondary)] text-white font-semibold rounded-lg hover:bg-[var(--color-primary)] transition-all duration-300 flex items-center justify-center gap-2 shadow-md transform hover:scale-[1.02] disabled:opacity-70 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                        <span>✨ Demander conseil</span>
                    </button>
                    <div id="ai-result-feedback" role="status" aria-live="polite" class="mt-4 min-h-[24px]"></div>
                </div>
            </section>
            
            <section id="quiz-tab" class="tab-content" aria-labelledby="quiz-title">
                <h2 id="quiz-title" class="text-3xl font-serif text-[var(--color-primary)] mb-5 text-center font-semibold">Quiz de Sagesse 🧠</h2>
                <div id="quiz-container" class="fade-in max-w-3xl mx-auto bg-[var(--color-bg-card)]/95 p-6 rounded-xl shadow-lg border border-[var(--color-border)]">
                    <div class="text-center p-8">
                        <span class="loader loader-dark"></span> 
                        <p class="mt-4 text-sm text-[var(--color-text-light)]">Chargement des données du Quiz...</p>
                    </div>
                </div>
            </section>

        </main>
    </div>
    
    <nav id="mobile-nav" class="sm:hidden fixed bottom-4 left-4 right-4 bg-[var(--color-bg-card)]/80 backdrop-blur-lg border border-[var(--color-border)] flex justify-around shadow-2xl z-50 rounded-full p-1">
        <button data-tab="accueil-tab" class="nav-btn mobile flex-1 flex flex-col items-center p-2 text-[var(--color-text)]">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            <span class="text-xs font-semibold">Accueil</span>
        </button>
        <button data-tab="explorer-tab" class="nav-btn mobile flex-1 flex flex-col items-center p-2 text-[var(--color-text)]">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            <span class="text-xs font-semibold">Explorer</span>
        </button>
        <button data-tab="favoris-tab" class="nav-btn mobile flex-1 flex flex-col items-center p-2 text-[var(--color-text)]">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
            <span class="text-xs font-semibold">Favoris</span>
        </button>
        <button data-tab="ai-sage-tab" class="nav-btn mobile flex-1 flex flex-col items-center p-2 text-[var(--color-text)]">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
            <span class="text-xs font-semibold">Sage AI</span>
        </button>
        <button data-tab="quiz-tab" class="nav-btn mobile flex-1 flex flex-col items-center p-2 text-[var(--color-text)]">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
            <span class="text-xs font-semibold">Quiz</span>
        </button>
    </nav>

    <div id="toast" role="status" aria-live="polite" class="fixed bottom-[-100px] left-1/2 -translate-x-1/2 bg-green-700 text-white py-2 px-5 rounded-full shadow-xl opacity-0 z-[1000]">
        <p>Message</p>
    </div>

    <button id="back-to-top" title="Retour en haut" aria-label="Retourner en haut de la page" class="fixed bottom-[100px] sm:bottom-10 right-5 p-3 bg-[var(--color-secondary)] text-white rounded-full shadow-xl hover:bg-[var(--color-primary)] focus:outline-none transition-all opacity-0 visibility-hidden transform-gpu translate-y-5 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>
    </button>
    
    <div id="modal-backdrop" class="fixed inset-0 bg-black/60 z-[100] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-title" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-2xl max-h-[85vh] bg-[var(--color-bg-card)] rounded-lg shadow-2xl z-[101] opacity-0 scale-95 pointer-events-none transition-all duration-300 flex flex-col">
        <header class="flex-shrink-0 p-6 pb-4 pr-12 border-b border-[var(--color-border)]">
            <h2 id="modal-title" class="text-2xl font-serif text-[var(--color-heading)] font-bold">Explication du Proverbe</h2>
            <button id="modal-close-btn" aria-label="Fermer la fenêtre modale" class="absolute top-4 right-4 p-2 text-[var(--color-text-light)] hover:text-[var(--color-text)] transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </header>
        <div id="modal-body" class="p-6 flex-grow overflow-y-auto custom-scrollbar">
            </div>
        <footer class="flex-shrink-0 p-4 border-t border-[var(--color-border)] flex justify-end">
             <button id="modal-favorite-btn" class="favorite-btn action-btn text-[var(--color-text-light)] hover:text-pink-500 flex items-center gap-1 font-semibold px-4 py-2 rounded-lg" data-id="" aria-label="Ajouter/Retirer des favoris">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                <span id="modal-favorite-text">Ajouter aux favoris</span>
            </button>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Mappage DOM et Variables Globales ---
            const dom = {
                // Navigations et structure
                accueilTab: document.getElementById('accueil-tab'),
                explorerTab: document.getElementById('explorer-tab'),
                favorisTab: document.getElementById('favoris-tab'),
                aiSageTab: document.getElementById('ai-sage-tab'),
                quizTab: document.getElementById('quiz-tab'),
                navButtons: document.querySelectorAll('.nav-btn'),
                mobileNav: document.getElementById('mobile-nav'),
                desktopNav: document.getElementById('desktop-nav'),
                
                // Accueil
                proverbOfTheDayCard: document.getElementById('proverb-of-the-day-card'),
                
                // Explorer (CORRIGÉ)
                searchInput: document.getElementById('search-input'),
                randomBtn: document.getElementById('random-btn'),
                themeListContainer: document.getElementById('theme-list-container'),
                resultsFeedback: document.getElementById('results-feedback'),
                resultsContainer: document.getElementById('results-container'),
                initialLoadMessage: document.getElementById('initial-load-message'),
                noResults: document.getElementById('no-results'),
                loadMoreBtn: document.getElementById('load-more-btn'),
                clearSearchBtn: document.querySelector('.clear-search-btn'),
                explorerTabBtn: document.querySelector('[data-tab="explorer-tab"]'),

                // Favoris
                favoritesContainer: document.getElementById('favorites-container'),
                noFavorites: document.getElementById('no-favorites'),
                goToExplorerBtn: document.getElementById('go-to-explorer-btn'),

                // AI Sage
                aiContextInput: document.getElementById('ai-context-input'),
                aiSuggestBtn: document.getElementById('ai-suggest-btn'),
                aiResultFeedback: document.getElementById('ai-result-feedback'),

                // Quiz
                quizContainer: document.getElementById('quiz-container'),

                // Modale
                modalBackdrop: document.getElementById('modal-backdrop'),
                modalContent: document.getElementById('modal-content'),
                modalCloseBtn: document.getElementById('modal-close-btn'),
                modalTitle: document.getElementById('modal-title'),
                modalBody: document.getElementById('modal-body'),
                modalFavoriteBtn: document.getElementById('modal-favorite-btn'),
                modalFavoriteText: document.getElementById('modal-favorite-text'),

                // Général
                themeToggle: document.getElementById('theme-toggle'),
                toast: document.getElementById('toast'),
                splashScreen: document.getElementById('splash-screen'),
                backToTop: document.getElementById('back-to-top'),
                aboutBtn: document.getElementById('about-btn'),
            };

            let proverbs = [];
            let favorites = JSON.parse(localStorage.getItem('kabyleProverbsFavorites') || '[]');
            let currentQuiz = null;

            // --- NOUVELLES VARIABLES GLOBALES POUR LA RECHERCHE ET LA PAGINATION ---
            const PROVERBS_PER_PAGE = 50;
            let filteredProverbs = [];
            let currentDisplayCount = 0;
            let currentSearchTerm = '';
            let currentTheme = null;
            let allThemes = [];

            // --- FONCTIONS UTILITAIRES ---
            
            /**
             * Normalise la chaîne de caractères (retire les accents et passe en minuscule)
             * pour une recherche plus tolérante.
             */
            const normalizeString = (str) => {
                if (!str) return '';
                // Supprime les accents et passe en minuscule
                return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            };

            /**
             * Fonction de surlignage simple.
             * Utilise une expression régulière pour une recherche insensible à la casse et globale.
             */
            const highlightText = (text, term) => {
                if (!term || term.length < 2) return text;
                
                // Échapper les caractères spéciaux pour l'utilisation dans une RegExp
                const escapedTerm = term.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                
                // Utiliser une expression régulière insensible à la casse
                const regex = new RegExp(`(${escapedTerm})`, 'gi');
                
                // Ne surligner que si le terme est trouvé (utile pour les thèmes)
                if (regex.test(text)) {
                    // Remplacer les correspondances par l'élément de surlignage
                    return text.replace(regex, '<span class="search-highlight">$1</span>');
                }
                return text;
            };

            /**
             * Crée le HTML pour une carte de proverbe.
             */
            const createProverbCardHTML = (proverb, isDaily = false, highlightTerm = '') => {
                const proverbText = highlightText(proverb.proverb, highlightTerm);
                const translationText = highlightText(proverb.translation, highlightTerm);
                
                // Utiliser highlightText pour les thèmes si le terme recherché correspond à un thème
                const themeBadges = (proverb.theme || []).map(theme => {
                    // On surligne le thème si le terme correspond
                    const themeHighlighted = highlightText(theme, highlightTerm);
                    return `<span class="card-theme-badge text-xs font-medium px-2 py-1 rounded-full bg-[var(--color-bg-alt)] hover:bg-[var(--color-accent)] text-[var(--color-text)] cursor-pointer select-none" data-theme="${theme.replace(/'/g, "\\'")}" title="Filtrer par ce thème">${themeHighlighted}</span>`;
                }).join('');

                const isFav = isFavorite(proverb.id);

                return `<div class="proverb-card bg-[var(--color-bg-card)] p-5 rounded-xl shadow-lg border-t-4 border-[var(--color-primary)] flex flex-col justify-between h-full fade-in" data-id="${proverb.id}">
                    <div>
                        <p class="text-xl font-serif font-bold text-[var(--color-heading)] mb-3">${proverbText}</p>
                        <p class="text-[var(--color-text)] mb-4 italic">"${translationText}"</p>
                    </div>
                    <div>
                        <div class="flex flex-wrap gap-2 mb-4">${themeBadges}</div>
                        <div class="flex justify-between items-center pt-3 border-t border-[var(--color-border)]">
                            <button class="favorite-btn action-btn text-[var(--color-text-light)] hover:text-pink-500 flex items-center gap-1 ${isFav ? 'favorited' : ''}" data-id="${proverb.id}" aria-label="Ajouter aux favoris">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="${isFav ? 'currentColor' : 'none'}" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                                <span class="text-sm hidden sm:inline">Favori</span>
                            </button>
                            <button class="action-btn text-[var(--color-primary)] hover:text-[var(--color-secondary)] flex items-center gap-1 font-semibold" data-id="${proverb.id}" data-action="explain" aria-label="Explication du proverbe">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
                                <span class="text-sm hidden sm:inline">Explication</span>
                            </button>
                        </div>
                    </div>
                    ${isDaily ? '<div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 px-3 py-1 bg-[var(--color-accent)] text-white text-xs font-bold rounded-full shadow-lg">DU JOUR</div>' : ''}
                </div>`;
            };

            const saveFavorites = () => {
                localStorage.setItem('kabyleProverbsFavorites', JSON.stringify(favorites));
                renderFavorites();
            };

            const isFavorite = (id) => favorites.includes(id);

            const toggleFavorite = (id) => {
                const index = favorites.indexOf(id);
                if (index > -1) {
                    favorites.splice(index, 1);
                    showToast('Proverbe retiré des favoris.', 'info');
                } else {
                    favorites.push(id);
                    showToast('Proverbe ajouté aux favoris !', 'success');
                }
                saveFavorites();
            };

            const showToast = (message, type = 'success') => {
                dom.toast.querySelector('p').textContent = message;
                dom.toast.className = 'fixed bottom-[-100px] left-1/2 -translate-x-1/2 py-2 px-5 rounded-full shadow-xl opacity-0 z-[1000] transition-all duration-500';
                
                let bgColor;
                if (type === 'success') bgColor = 'bg-green-700';
                else if (type === 'error') bgColor = 'bg-red-600';
                else bgColor = 'bg-gray-700';

                setTimeout(() => {
                    dom.toast.classList.add(bgColor, 'text-white', 'opacity-100');
                    dom.toast.style.bottom = '3rem'; // Rendre visible

                    setTimeout(() => {
                        dom.toast.style.bottom = '-100px';
                        dom.toast.classList.remove('opacity-100', bgColor);
                    }, 3000);
                }, 100);
            };

            const renderProverbInModal = (proverb) => {
                if (!proverb) return;

                const isFav = isFavorite(proverb.id);
                
                dom.modalTitle.textContent = proverb.proverb;
                dom.modalBody.innerHTML = `
                    <p class="text-lg text-[var(--color-text)] mb-6 italic font-medium">"${proverb.translation}"</p>
                    <div class="prose">
                        ${proverb.explanation ? `
                            <h3 class="text-xl font-serif text-[var(--color-primary)] mb-2">Explication</h3>
                            <p>${proverb.explanation}</p>
                        ` : '<p class="text-[var(--color-text-light)]">Aucune explication détaillée disponible pour ce proverbe.</p>'}
                        
                        ${(proverb.theme && proverb.theme.length > 0) ? `
                            <h3 class="text-xl font-serif text-[var(--color-primary)] mb-2">Thèmes</h3>
                            <p>${proverb.theme.join(', ')}</p>
                        ` : ''}
                    </div>
                `;
                
                dom.modalFavoriteBtn.setAttribute('data-id', proverb.id);
                dom.modalFavoriteBtn.classList.toggle('favorited', isFav);
                dom.modalFavoriteBtn.querySelector('#modal-favorite-text').textContent = isFav ? 'Retirer des favoris' : 'Ajouter aux favoris';

                dom.modalBackdrop.classList.add('visible');
                dom.modalContent.classList.add('visible');
                document.body.style.overflow = 'hidden';
            };

            const hideModal = () => {
                dom.modalBackdrop.classList.remove('visible');
                dom.modalContent.classList.remove('visible');
                document.body.style.overflow = '';
            };

            // --- LOGIQUE DE RECHERCHE ET DE FILTRAGE (CORRIGÉE) ---
            
            /**
             * Filtre l'ensemble des proverbes basé sur le terme de recherche et le thème actif.
             * Cette fonction est l'étape 1, elle travaille sur le grand fichier source.
             * @param {string} searchTerm
             * @param {string|null} theme
             * @returns {Array<Object>} Les proverbes filtrés.
             */
            const filterProverbs = (searchTerm, theme) => {
                const normalizedSearchTerm = normalizeString(searchTerm).trim();

                return proverbs.filter(p => {
                    let matchesTheme = true;

                    // 1. Filtrage par thème
                    if (theme) {
                        matchesTheme = p.theme && p.theme.includes(theme);
                    }
                    
                    if (!matchesTheme) return false; // Inutile de continuer si le thème ne correspond pas

                    // 2. Filtrage par terme de recherche
                    if (normalizedSearchTerm.length >= 2) {
                        const normalizedProverb = normalizeString(p.proverb);
                        const normalizedTranslation = normalizeString(p.translation || '');
                        const normalizedTheme = normalizeString(p.theme ? p.theme.join(' ') : '');
                        
                        // La recherche porte sur le proverbe, la traduction ET le thème
                        const matchesSearch = normalizedProverb.includes(normalizedSearchTerm) ||
                                              normalizedTranslation.includes(normalizedSearchTerm) ||
                                              normalizedTheme.includes(normalizedSearchTerm);
                                              
                        return matchesSearch;

                    } else if (normalizedSearchTerm.length === 1) {
                         // Recherche simple pour un seul caractère au début du proverbe
                         const normalizedProverb = normalizeString(p.proverb);
                         return normalizedProverb.startsWith(normalizedSearchTerm);
                    }
                    
                    // Si pas de terme de recherche (moins de 1 caractère), le match est validé si le thème match
                    return true;
                });
            };
            
            /**
             * Affiche la tranche actuelle des proverbes filtrés (pagination).
             */
            const displayProverbsSlice = () => {
                const start = currentDisplayCount;
                const end = Math.min(filteredProverbs.length, start + PROVERBS_PERV_PAGE);
                
                const slice = filteredProverbs.slice(start, end);

                if (start === 0) {
                    dom.resultsContainer.innerHTML = ''; // Nettoyer pour un nouveau filtre
                    dom.initialLoadMessage.classList.add('hidden');
                }

                slice.forEach((proverb, index) => {
                    // Utiliser le highlightTerm même si on filtre par thème (pour surligner les parties)
                    const highlightForCard = currentSearchTerm || (currentTheme && currentTheme !== 'Tout' ? currentTheme : '');
                    const cardHtml = createProverbCardHTML(proverb, false, highlightForCard);
                    const card = document.createElement('div');
                    card.innerHTML = cardHtml.trim();
                    card.style.animationDelay = `${index * 0.05}s`;
                    card.classList.add('stagger-in');
                    dom.resultsContainer.appendChild(card.firstChild);
                });
                
                currentDisplayCount = end;

                // Mettre à jour le bouton "Charger Plus"
                if (currentDisplayCount < filteredProverbs.length) {
                    dom.loadMoreBtn.classList.remove('hidden');
                    dom.loadMoreBtn.innerHTML = `Charger ${Math.min(PROVERBS_PER_PAGE, filteredProverbs.length - currentDisplayCount)} proverbes supplémentaires`;
                    dom.loadMoreBtn.classList.remove('loading');
                    dom.loadMoreBtn.disabled = false;
                } else {
                    dom.loadMoreBtn.classList.add('hidden');
                }

                // Mettre à jour les messages de résultat
                if (filteredProverbs.length === 0) {
                    dom.noResults.classList.remove('hidden');
                    dom.resultsFeedback.textContent = '';
                } else {
                    dom.noResults.classList.add('hidden');
                    dom.resultsFeedback.textContent = `Affichage de ${currentDisplayCount} sur ${filteredProverbs.length} proverbes trouvés.`;
                }
            };
            
            /**
             * Gère le filtrage complet et l'affichage initial. C'est la fonction principale de l'onglet Explorer.
             * @param {string} searchTerm
             * @param {string|null} theme
             */
            const filterAndDisplayProverbs = (searchTerm, theme) => {
                // Étape 1: Filtrer l'ensemble du grand fichier source
                filteredProverbs = filterProverbs(searchTerm, theme);
                currentDisplayCount = 0;
                currentSearchTerm = searchTerm;
                currentTheme = theme;

                // Étape 2: Afficher la première tranche paginée
                dom.resultsContainer.innerHTML = ''; // Nettoyer l'affichage précédent
                dom.initialLoadMessage.classList.add('hidden');

                if (filteredProverbs.length > 0) {
                    displayProverbsSlice();
                } else {
                    dom.resultsFeedback.textContent = '';
                    dom.loadMoreBtn.classList.add('hidden');
                    dom.noResults.classList.remove('hidden');
                    dom.initialLoadMessage.classList.add('hidden');
                }
            };
            
            /**
             * Gère la recherche instantanée (déclenchée par l'input).
             */
            const handleSearchInput = () => {
                const searchTerm = dom.searchInput.value.trim();
                
                // Si l'utilisateur tape une recherche, on désactive le filtre de thème pour la recherche textuelle
                const activeTheme = searchTerm === '' ? currentTheme : null;

                // Mettre à jour l'état visuel du filtre de thème
                document.querySelectorAll('.theme-pill-button').forEach(btn => {
                    const btnTheme = btn.dataset.theme;
                    btn.classList.remove('active');
                    if (searchTerm === '' && btnTheme === currentTheme) {
                        btn.classList.add('active');
                    } else if (searchTerm === '' && !currentTheme && btnTheme === '') {
                        btn.classList.add('active');
                    }
                });
                
                filterAndDisplayProverbs(searchTerm, activeTheme);
            };

            /**
             * Gère le clic sur le bouton Aléatoire.
             */
            const handleRandomClick = () => {
                if (proverbs.length === 0) {
                    showToast("Erreur: La banque de proverbes n'est pas chargée.", 'error');
                    return;
                }

                // 1. Désactiver la recherche et le filtre de thème
                dom.searchInput.value = '';
                currentTheme = null;
                document.querySelectorAll('.theme-pill-button').forEach(btn => btn.classList.remove('active'));
                document.querySelector('.theme-pill-button[data-theme=""]').classList.add('active'); // Activer "Tout"

                // 2. Sélectionner un proverbe aléatoire parmi TOUS
                const randomIndex = Math.floor(Math.random() * proverbs.length);
                const randomProverb = proverbs[randomIndex];
                
                // 3. Simuler le filtrage pour n'afficher que le proverbe aléatoire.
                filteredProverbs = [randomProverb];
                currentDisplayCount = 0;
                currentSearchTerm = '';
                
                // 4. Afficher le résultat unique
                dom.resultsContainer.innerHTML = '';
                dom.initialLoadMessage.classList.add('hidden');
                dom.noResults.classList.add('hidden');
                dom.loadMoreBtn.classList.add('hidden');
                dom.resultsFeedback.textContent = "Proverbe aléatoire affiché.";
                
                const cardHtml = createProverbCardHTML(randomProverb, false, '');
                const card = document.createElement('div');
                card.innerHTML = cardHtml.trim();
                dom.resultsContainer.appendChild(card.firstChild);
                
                // Faire défiler vers le résultat
                dom.explorerTab.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Ajouter une petite animation pour le focus
                const randomCard = dom.resultsContainer.querySelector(`.proverb-card[data-id="${randomProverb.id}"]`);
                if(randomCard) {
                    randomCard.classList.add('highlight');
                    setTimeout(() => randomCard.classList.remove('highlight'), 2000);
                }
            };
            
            /**
             * Met à jour la liste des thèmes disponibles dans la barre d'exploration.
             * Et attache les écouteurs d'événements pour le filtrage par thème.
             */
            const updateAvailableThemes = () => {
                dom.themeListContainer.innerHTML = '';
                // Extraire tous les thèmes uniques
                allThemes = [...new Set(proverbs.flatMap(p => p.theme || []).filter(t => t))].sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' }));

                allThemes.unshift("Tout"); // Ajout de l'option "Tout" au début

                allThemes.forEach(theme => {
                    const button = document.createElement('button');
                    button.textContent = theme;
                    button.setAttribute('data-theme', theme === 'Tout' ? '' : theme);
                    button.classList.add('theme-pill-button', 'flex-shrink-0', 'px-3', 'py-1', 'text-sm', 'font-semibold', 'rounded-full', 'border', 'border-[var(--color-border)]', 'bg-[var(--color-bg-alt)]', 'text-[var(--color-text)]', 'hover:bg-[var(--color-primary)]/80', 'hover:text-white', 'whitespace-nowrap', 'shadow-sm');

                    if ((!currentTheme && theme === 'Tout') || (currentTheme === theme)) {
                        button.classList.add('active');
                    }
                    
                    // Gestion du clic pour le filtre par thème
                    button.addEventListener('click', () => {
                        dom.searchInput.value = ''; // Réinitialiser la recherche

                        const newTheme = button.getAttribute('data-theme');
                        
                        // Si l'utilisateur clique sur le thème actif, on le désélectionne (sauf pour "Tout")
                        if (newTheme === currentTheme && newTheme !== '') {
                            currentTheme = null;
                        } else {
                            currentTheme = newTheme;
                        }
                        
                        // Mettre à jour les classes actives des boutons
                        document.querySelectorAll('.theme-pill-button').forEach(btn => btn.classList.remove('active'));
                        if (currentTheme) {
                             document.querySelector(`.theme-pill-button[data-theme='${currentTheme}']`).classList.add('active');
                        } else {
                             // Si aucun thème sélectionné, active "Tout"
                             document.querySelector(`.theme-pill-button[data-theme='']`).classList.add('active');
                        }

                        filterAndDisplayProverbs('', currentTheme);
                    });

                    dom.themeListContainer.appendChild(button);
                });
                
                // S'assurer qu'un thème par défaut est sélectionné (le premier ou 'Tout')
                 if (!currentTheme) {
                     document.querySelector('.theme-pill-button[data-theme=""]').classList.add('active');
                 }
            };

            // --- LOGIQUE DES FAVORIS ---
            
            const renderFavorites = () => {
                dom.favoritesContainer.innerHTML = '';
                const favProverbs = proverbs.filter(p => isFavorite(p.id));
                
                if (favProverbs.length === 0) {
                    dom.noFavorites.classList.remove('hidden');
                } else {
                    dom.noFavorites.classList.add('hidden');
                    favProverbs.forEach((proverb, index) => {
                         const cardHtml = createProverbCardHTML(proverb);
                         const card = document.createElement('div');
                         card.innerHTML = cardHtml.trim();
                         card.style.animationDelay = `${index * 0.05}s`;
                         card.classList.add('stagger-in');
                         dom.favoritesContainer.appendChild(card.firstChild);
                    });
                }
            };

            // --- LOGIQUE DU QUIZ (LAISSE LE MARQUEUR DE CHARGEMENT) ---
            
            // Simule l'initialisation du quiz après le chargement des données
            const initQuiz = () => {
                 dom.quizContainer.innerHTML = '<p class="text-center text-[var(--color-text-light)]">Le Quiz sera disponible bientôt.</p>';
            };

            // --- GESTION DES MODALES ET ÉVÉNEMENTS GÉNERAUX ---

            const initModal = () => {
                dom.modalCloseBtn.addEventListener('click', hideModal);
                dom.modalBackdrop.addEventListener('click', hideModal);
                
                dom.modalContent.addEventListener('click', (e) => {
                    if (e.target.closest('.favorite-btn')) {
                        const id = dom.modalFavoriteBtn.getAttribute('data-id');
                        toggleFavorite(id);
                        
                        // Mettre à jour l'état du bouton dans la modale
                        const isFav = isFavorite(id);
                        dom.modalFavoriteBtn.classList.toggle('favorited', isFav);
                        dom.modalFavoriteBtn.querySelector('#modal-favorite-text').textContent = isFav ? 'Retirer des favoris' : 'Ajouter aux favoris';

                        // Mettre à jour l'état du bouton dans l'onglet explorer/favoris si la carte existe
                        const cardButton = document.querySelector(`.proverb-card[data-id="${id}"] .favorite-btn`);
                        if (cardButton) {
                             cardButton.classList.toggle('favorited', isFav);
                             cardButton.querySelector('svg').setAttribute('fill', isFav ? 'currentColor' : 'none');
                        }
                    }
                });
            };

            const initThemeToggle = () => {
                const isSystemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const isDark = localStorage.theme === 'dark' || (!('theme' in localStorage) && isSystemDark);

                if (isDark) {
                    document.documentElement.classList.add('dark');
                    dom.themeToggle.querySelector('#theme-icon-light').classList.add('hidden');
                    dom.themeToggle.querySelector('#theme-icon-dark').classList.remove('hidden');
                } else {
                    document.documentElement.classList.remove('dark');
                    dom.themeToggle.querySelector('#theme-icon-light').classList.remove('hidden');
                    dom.themeToggle.querySelector('#theme-icon-dark').classList.add('hidden');
                }

                dom.themeToggle.addEventListener('click', () => {
                    const isCurrentlyDark = document.documentElement.classList.contains('dark');
                    if (isCurrentlyDark) {
                        document.documentElement.classList.remove('dark');
                        localStorage.theme = 'light';
                        dom.themeToggle.querySelector('#theme-icon-light').classList.remove('hidden');
                        dom.themeToggle.querySelector('#theme-icon-dark').classList.add('hidden');
                    } else {
                        document.documentElement.classList.add('dark');
                        localStorage.theme = 'dark';
                        dom.themeToggle.querySelector('#theme-icon-light').classList.add('hidden');
                        dom.themeToggle.querySelector('#theme-icon-dark').classList.remove('hidden');
                    }
                });
            };

            const initNavigation = () => {
                let currentTab = dom.accueilTab.id;

                const switchTab = (tabId) => {
                    document.querySelectorAll('.tab-content').forEach(section => {
                        section.classList.remove('active');
                    });
                    document.getElementById(tabId).classList.add('active');

                    dom.navButtons.forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.dataset.tab === tabId) {
                            btn.classList.add('active');
                        }
                    });

                    currentTab = tabId;
                    
                    // Actions spécifiques à l'onglet
                    if (tabId === 'favoris-tab') {
                        renderFavorites();
                    } else if (tabId === 'explorer-tab') {
                        // Relancer l'affichage initial/filtré si on revient sur explorer
                        filterAndDisplayProverbs(currentSearchTerm, currentTheme);
                    }
                };

                dom.navButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        switchTab(btn.dataset.tab);
                    });
                });

                // Activation de l'onglet par défaut (Accueil)
                switchTab(currentTab);
            };

            const initScroll = () => {
                const showBackToTop = () => {
                    if (window.scrollY > 300) {
                        dom.backToTop.classList.add('visible');
                    } else {
                        dom.backToTop.classList.remove('visible');
                    }
                };

                window.addEventListener('scroll', showBackToTop);
                
                dom.backToTop.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            };
            
            // Écouteur de clic délégué pour les boutons de carte (Favoris/Explication)
            const initCardListeners = () => {
                const delegatedHandler = (e) => {
                    const cardButton = e.target.closest('.action-btn');
                    if (!cardButton) return;
                    
                    const proverbId = parseInt(cardButton.dataset.id);
                    const proverb = proverbs.find(p => p.id === proverbId);

                    if (cardButton.classList.contains('favorite-btn')) {
                        toggleFavorite(proverbId);
                        // Mettre à jour le statut du bouton dans la carte
                        cardButton.classList.toggle('favorited', isFavorite(proverbId));
                        cardButton.querySelector('svg').setAttribute('fill', isFavorite(proverbId) ? 'currentColor' : 'none');
                        if (dom.modalContent.classList.contains('visible') && dom.modalFavoriteBtn.dataset.id == proverbId) {
                           // Mettre à jour la modale si elle est ouverte sur ce proverbe
                           dom.modalFavoriteBtn.classList.toggle('favorited', isFavorite(proverbId));
                           dom.modalFavoriteBtn.querySelector('#modal-favorite-text').textContent = isFavorite(proverbId) ? 'Retirer des favoris' : 'Ajouter aux favoris';
                        }
                    } else if (cardButton.dataset.action === 'explain') {
                        renderProverbInModal(proverb);
                    }
                };

                dom.resultsContainer.addEventListener('click', delegatedHandler);
                dom.favoritesContainer.addEventListener('click', delegatedHandler);
            };
            
            // --- NOUVEAUX ÉCOUTEURS D'ÉVÉNEMENTS POUR L'EXPLORATEUR (CORRIGÉ) ---
            
            const initExplorerListeners = () => {
                // Recherche instantanée
                dom.searchInput.addEventListener('input', handleSearchInput);
                
                // Bouton Aléatoire
                dom.randomBtn.addEventListener('click', handleRandomClick);
                
                // Bouton Effacer la recherche
                dom.clearSearchBtn.addEventListener('click', () => {
                    dom.searchInput.value = '';
                    handleSearchInput(); // Relance la recherche pour afficher tous les résultats ou filtrer par thème
                    dom.searchInput.focus();
                });
                
                // Bouton "Charger Plus" (Pagination)
                dom.loadMoreBtn.addEventListener('click', () => {
                    if (!dom.loadMoreBtn.disabled) {
                        dom.loadMoreBtn.classList.add('loading');
                        dom.loadMoreBtn.disabled = true;
                        // Délai pour simuler un petit chargement
                        setTimeout(() => {
                            displayProverbsSlice();
                        }, 100); 
                    }
                });
                
                // Gestionnaire de clics pour les badges de thème dans les cartes (délégation d'événements)
                dom.resultsContainer.addEventListener('click', (e) => {
                    const badge = e.target.closest('.card-theme-badge');
                    if (badge) {
                        const theme = badge.dataset.theme;
                        if (theme) {
                            // Basculer vers l'onglet Explorer
                            dom.explorerTabBtn.click();
                            
                            // Appliquer le filtre de thème
                            currentTheme = theme;
                            dom.searchInput.value = '';
                            document.querySelectorAll('.theme-pill-button').forEach(btn => btn.classList.remove('active'));
                            const targetBtn = document.querySelector(`.theme-pill-button[data-theme='${theme}']`);
                            if(targetBtn) targetBtn.classList.add('active');
                            
                            filterAndDisplayProverbs('', currentTheme);
                            
                            // Scroll vers le haut de la zone de résultats
                            dom.explorerTab.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }
                });

                dom.goToExplorerBtn.addEventListener('click', () => {
                    dom.explorerTabBtn.click();
                    dom.searchInput.focus();
                });
            };

            // --- FONCTION PRINCIPALE ---

            const main = () => {
                // 1. Initialiser le thème, la navigation et le scroll
                initThemeToggle();
                initNavigation();
                initScroll();
                initModal();

                // 2. Charger les données du fichier proverbs.json
                fetch('proverbs.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('proverbs.json non trouvé ou erreur de réseau.');
                        }
                        return response.json();
                    })
                    .then(data => {
                        proverbs = data;
                        
                        // 3. Initialiser les écouteurs de l'explorateur (maintenant que les données sont chargées)
                        initExplorerListeners();
                        initCardListeners();
                        initQuiz();
                        
                        // 4. Afficher le proverbe du jour (aléatoire)
                        const dailyProverb = proverbs[Math.floor(Math.random() * proverbs.length)];
                        dom.proverbOfTheDayCard.innerHTML = createProverbCardHTML(dailyProverb, true);

                        // 5. Initialiser les filtres de l'explorateur et l'affichage initial
                        updateAvailableThemes();
                        
                        // Charger les premiers résultats de l'explorateur (avec le filtre par défaut 'Tout')
                        currentTheme = ''; // Thème par défaut 'Tout'
                        filterAndDisplayProverbs('', currentTheme);
                        
                        // 6. Masquer l'écran de chargement
                        setTimeout(() => dom.splashScreen.classList.add('hidden'), 500);
                    })
                    .catch(error => {
                        console.error("Could not load proverbs:", error);
                        const errorMessage = `<h1 class="text-2xl font-bold text-red-600">Erreur de chargement</h1>
                            <p class="text-red-500 mt-2">Impossible de charger la banque de proverbes (proverbs.json). <br> ${error.message}</p>
                            <p class="mt-4 text-[var(--color-text-light)]">Veuillez vérifier que le fichier est bien présent et non corrompu.</p>`;
                        dom.initialLoadMessage.innerHTML = errorMessage;
                        dom.proverbOfTheDayCard.innerHTML = `<p class="text-center text-red-500">Erreur de chargement.</p>`;
                        dom.themeListContainer.innerHTML = `<p class="text-center text-red-500 text-sm">Erreur.</p>`;
                        dom.quizContainer.innerHTML = `<p class="text-center text-red-500">Erreur de chargement des données.</p>`;
                        setTimeout(() => dom.splashScreen.classList.add('hidden'), 100);
                    });
            };

            main();
        });
    </script>
</body>
</html>
